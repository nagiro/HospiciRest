<html>
    <header>
        
        <meta charset="UTF-8">
        
        <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>        
        <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-/bQdsTh/da6pkI1MST/rWKFNjaCP5gBSY4sEBT38Q/9RBh9AH40zEOg7Hlq2THRZ" crossorigin="anonymous"></script>
        <script src="https://unpkg.com/vuejs-datepicker"></script>        

        <style>
            label { font-weight: bold;}
            h1 { font-weight: bolder; }                                    
        </style>
    </header>
    <body>
        <div class="marc" id="app">

            <div class="container">
                <h1>Control horari</h1>
                <div class="row" style="margin-top: 5vw; ">
                    <div class="col">
                        <button v-if="BotoEstat == 'on'" type="button" class="btn btn-success" @click="Inicia()">Començo a treballar</button>
                        <button v-if="BotoEstat == 'off'" type="button" class="btn btn-info" @click="Para()">Paro de treballar</button>                        
                    </div>                    
                </div>
                <div class="row" style="margin-top: 5vw; ">

                    <div class="card col">
                        <div class="card-body">
                          <h5 class="card-title">Hores treballades</h5>
                          <ul class="list-group">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                De l'últim inici fins ara
                              <span class="badge bg-primary rounded-pill">{{HoresTreballadesActualment}} min. / {{(HoresTreballadesActualment/60).toFixed(1)}} h</span>
                            </li>                            
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Avui has treballat
                              <span class="badge bg-primary rounded-pill">{{HoresAvui}} min. / {{(HoresAvui/60).toFixed(1)}} h</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Aquesta setmana has treballat
                              <span class="badge bg-primary rounded-pill">{{HoresSetmana}} min. / {{(HoresSetmana/60).toFixed(1)}} h</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Aquest mes has treballat
                              <span class="badge bg-primary rounded-pill">{{HoresMes}} min. / {{(HoresMes/60).toFixed(1)}} h </span>
                            </li>
                          </ul>
                          
                        </div>
                    </div>          
                </div>          

                <div class="row" style="margin-top: 3vw">

                    <div class="card col">
                        <div class="card-body">
                          <h5 class="card-title">Detall hores</h5>                          
                          <div class="input-group">
                            <span class="input-group-text">Mes / Any</span>
                            <input type="text" v-model="ConsultaMes" @change="Consulta()" class="form-control">
                            <input type="text" v-model="ConsultaAny" @change="Consulta()" class="form-control">
                          </div>                          
                          <table class="table">
                            <thead>
                              <tr>                                
                                <th scope="col">Dia</th>
                                <th scope="col">Inici</th>
                                <th scope="col">Fi</th>
                                <th scope="col">Minuts</th>
                              </tr>
                            </thead>
                            <tbody>
                              <tr v-for="DH of DetallHores ">                                
                                <td>{{DH.Data}}</td>
                                <td>{{DH.HoraInici}}</td>
                                <td>{{DH.HoraFi}}</td>
                                <td>{{DH.Total}}</td>
                              </tr>
                            </tbody>
                          </table>
                          
                        </div>
                    </div>                    

                </div>
                

            </div>
        </div>
        
    </body>
    <script>
        var app = new Vue({
                el: '#app',
                data: {           
                    SUBMIT_URL: '/apiweb/apiControlHorari',                    
                    IDS: 1,
                    IDU: 0,
                    
                    BotoEstat: '',
                    ConsultaMes: '',
                    ConsultaAny: '',
                    Errors: '',
                    HoresAvui: 0,
                    HoresSetmana: 0,
                    HoresMes: 0,
                    DetallHores: [],
                    HoresTreballadesActualment: 0,

                },
                created () {
                    const queryString = window.location.search;
                    const urlParams = new URLSearchParams(queryString);
                    
                    this.IDS = urlParams.get('idS');
                    this.IDU = urlParams.get('idU');
                    if(this.IDS > 0 && this.IDU > 0 && !isNaN(this.IDS) && !isNaN(this.IDU) ) {
                        this.loadData(this.IDS, this.IDU);
                    } else {
                        alert('Paràmetres incorrectes.');
                    }
                },
                methods: {                    
                    loadData(idS, idU, accio = 'idle', mesAny = '') {
                        
                        if(mesAny == '') { mesAny = (new Date().getMonth()+1).toString() + (new Date().getFullYear()).toString(); }                                                
                        const Url = this.SUBMIT_URL + '?idS=' + idS + '&idU=' + idU + '&accio=' + accio + '&MesAny=' + mesAny;
                        // r = array('Dia' => 0, 'Setmana' => 0, 'Mes' => 0, 'Error' => '', 'MesMostrat' => date('m'), 'EstatBoto' => '');
                        axios.get( Url )
                            .then( (r) => { 
                                this.HoresAvui = r.data.Dia;  
                                this.HoresSetmana = r.data.Setmana;
                                this.HoresMes = r.data.Mes;
                                this.BotoEstat = r.data.EstatBoto;
                                this.DetallHores = r.data.DetallHores;
                                this.HoresTreballadesActualment = r.data.TempsActualTreballat;

                            })
                            .catch( (e) => { });                    
                    },
                    Inicia() {
                        this.loadData(this.IDS, this.IDU, 'on');                 
                    },
                    Para() {
                        this.loadData(this.IDS, this.IDU, 'off');                 
                    },
                    Consulta() {
                        if( ( this.ConsultaAny.length == 4 && this.ConsultaMes.length == 2 && !isNaN(this.ConsultaAny) && !isNaN(this.ConsultaMes) )
                            || ( this.ConsultaAny.length == 0 && this.ConsultaMes.length == 0 )
                        ) {
                            this.loadData(this.IDS, this.IDU, 'idle', (this.ConsultaMes.toString()+this.ConsultaAny.toString()));
                        }
                    }             
                }
        });            
    </script>

</html>